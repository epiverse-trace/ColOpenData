---
title: "Integration of Geospatial and Demographic data"
output: 
  rmarkdown::html_vignette:
    df_print: tibble
vignette: >
  %\VignetteIndexEntry{Integration of Geospatial and Demographic data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

::: {style="text-align: justify;"}
As you know, **ColOpenData** can be used to access both [geospatial](https://epiverse-trace.github.io/ColOpenData/articles/geospatial_data.html) and [demographic](https://epiverse-trace.github.io/ColOpenData/articles/demographic_data.html) data from Colombia, in independent modules. However, we thought it would be helpful to present a module that incorporates a way to merge information between geospatial and demographic data. In this vignette you will learn how to use the function `merge_geo_demographic()`.
:::

```{r libraries, message=FALSE, warning=FALSE, results="hide"}
library(ColOpenData)
library(ggplot2)
```

::: {style="text-align: justify;"}
**Disclaimer: all data is loaded to the environment in the user's R session, but is not downloaded to user's computer.**
:::

## How to merge geospatial and demographic data

### Documentation access

::: {style="text-align: justify;"}
Geospatial and demographic data can be merged based on the spatial aggregation level (SAL). While geospatial data can be aggregated down to the block level, demographic data is typically available only at the department and municipality levels. Therefore, these are the only SAL that can be accessed in both types of data for merging.

Now, the `merge_geo_demographic()` function takes two parameters: the demographic dataset and the column of interest in the demographic dataset. To use the function correctly, it's important to review the demographic dataset we intend to work with and their respective SAL. Therefore, we should first access the demographic documentation.
:::

```{r documentation, echo =TRUE}
# Available demographic datasets
datasets_dem <- list_datasets("demographic")

# Available demographic datasets at the department level
department_datasets <- datasets_dem[datasets_dem$level == "department", ]
head(department_datasets)
```

::: {style="text-align: justify;"}
After reviewing the available datasets, we can select the one we wish to work with and take a closer look. For instance, let's suppose we choose the dataset "DANE_CNPVPS_2018_4PD".
:::

```{r data, echo =TRUE}
# Download demographic dataset
chosen_data <- download_demographic("DANE_CNPVPS_2018_4PD")
head(chosen_data)
```

::: {style="text-align: justify;"}
`chosen_data` presents information regarding disabilities and main limitations in activities in the column  "limitacion_que_mas_afecta_el_desempeno_de_la_persona".
:::

```{r merge data, echo =TRUE}
# Download demographic dataset
column <- "limitacion_que_mas_afecta_el_desempeno_de_la_persona"
merged_data <- merge_geo_demographic("DANE_CNPVPS_2018_4PD", column)
head(merged_data)
```
::: {style="text-align: justify;"}
`merged_data` presents geospatial information related to departments, as well as the information related to main limitations among the population. We can use this dataset to plot the number of people by department that have a certain limitation, for example, speech, which is now reported under "hablar_o_conversar".
:::

```{r}
ggplot(data = merged_data) +
  geom_sf(mapping = aes(fill = hablar_o_conversar), color = "white") +
  theme_minimal() +
  theme(
    panel.grid = element_blank(),
    axis.text = element_blank(),
    axis.ticks = element_blank()
  ) +
  scale_fill_gradient("Count", low = "#10bed2", high = "#deff00") +
  ggtitle(
    label = "People who reported speech as their main limitation",
    subtitle = "Colombia"
  )
```

